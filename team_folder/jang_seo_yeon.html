<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="../js/jquery-3.7.1.min.js"></script>

    <link href="../css/common.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">

    <title>3ì¡° : ë³´ëŒì‚¼ì¡°</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Gowun+Dodum&display=swap');

        * { font-family: 'Gowun Dodum', sans-serif; }
        body { margin: 0; padding: 100px; background-color: rgb(231, 243, 252); color: black; }
        .container { width: 80%; max-width: 1000px; background-color: white; padding: 40px; border-radius: 12px; text-align: center; }
        img { width: 50%; height: auto; }
        #profile { font-size: 3rem; }
        #name { font-size: 2rem; }
        table { width: 80%; border-collapse: collapse; margin: auto; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 12px 20px; text-align: left; vertical-align: middle; font-size: 1.5rem; word-break: break-word; }
        th { background-color: #f2f2f2; font-weight: bold; }
        .post { margin-top: 20px; }
        .post h4 { text-align: center; margin-top: 10rem; margin-bottom: 10px; }
        .btn_area { text-align: right; }
        #add_btn { background-color: #00235a; color: #fff; padding: 1rem; border-radius: 12px; }
        #guestbook { display: none; margin-top: 16px; }
        .gb_form { margin-bottom: 10rem; display: grid; grid-template-columns: 1fr 170px; grid-auto-rows: auto; gap: 12px; align-items: start; text-align: left; }
        #gb_comment { grid-column: 1 / 2; min-height: 84px; width: 100%; padding: 12px 14px; border: 1px solid #cbd5e1; border-radius: 10px; background: #f8fafc; outline: none; }
        #gb_pwd { grid-column: 2 / 3; width: 100%; height: 48px; padding: 12px 14px; border: 1px solid #cbd5e1; border-radius: 10px; background: #f8fafc; outline: none; letter-spacing: 0.2rem; text-align: center; }
        #save_btn { grid-column: -1; padding: 12px 18px; border: 0; border-radius: 12px; background: #00235a; color: #fff; cursor: pointer; }
        #comment_list .comment_item { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; }
        #comment_list .comment_item>p { font-size: 1.5rem; text-align: left; flex: 1 1 auto; }
        #comment_list .comment_item>div { display: flex; gap: 8px; margin-left: 12px; flex-shrink: 0; }
        #comment_list .comment_item>hr { flex: 0 0 100%; margin: 8px 0; }

    </style>
</head>

<body>
    <div class="container">
        <h2 id="profile">Profile</h2>
        <br>

        <div>
            <img src="../img/jang_seo_yeon/3.jpg">
            <h3 id="name">ì¥ì„œì—°</h3>

            <p id="birth_date">2002.10.16<br>ì†Œí”„íŠ¸ì›¨ì–´ê³¼ 4í•™ë…„</p>
            <p id="content"></p>


        </div>

        <div>
            <table>
                <tbody>
                    <tr>
                        <th scope="row">ê°ì˜¤ í•œ ë§ˆë””</th>
                        <td>ì ë‹¹íˆ ì‚´ì§€ ë§ì</td>
                    </tr>
                    <tr>
                        <th scope="row">MBTI</th>
                        <td>INTP / ë‚´í–¥í˜• 90%</td>
                    </tr>
                    <tr>
                        <th scope="row">ì¢‹ì•„í•˜ëŠ” ê²ƒ</th>
                        <td>ê³ ì–‘ì´ğŸ±, í•˜ëŠ˜ìƒ‰â˜ï¸, ë§ˆë¼íƒ•ğŸœ, ì§‘ğŸ </td>
                    </tr>
                    <tr>
                        <th scope="row">velog</th>
                        <td><a href="https://velog.io/@syjang1016">https://velog.io/@syjang1016</a></td>
                    </tr>
                    <tr>
                        <th scope="row">ëª©í‘œ</th>
                        <td>í˜‘ì—… ëŠ¥ë ¥ ê¸°ë¥´ê¸°, í¬íŠ¸í´ë¦¬ì˜¤ ìŒ“ê¸°, ê¾¸ì¤€í•¨</td>
                    </tr>
                </tbody>
            </table>

        </div>


        <div class="post"> <!--ë°©ëª…ë¡-->
            <h4>ë°©ëª…ë¡</h4>
            <div class="btn_area">
                <button type="button" class="add_btn" id="add_btn">ì‘ì„±í•˜ê¸°</button>
            </div>
        </div>

        <div id="guestbook">
            <div class="gb_form">
                <textarea id="gb_comment" rows="4" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"></textarea>
                <input maxlength="4" type="password" id="gb_pwd" placeholder="ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬" />
                <button type="button" id="save_btn">ë“±ë¡</button>
            </div>
        </div>


        <div id="comment_list">


        </div>
    </div>



    </div>
</body>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
        getFirestore,
        collection,
        addDoc,
        serverTimestamp,
        getDocs,
        query,
        orderBy,
        doc,
        getDoc,
        updateDoc,
        deleteDoc
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
        apiKey: "AIzaSyCOfKG6lP22IAQ0b_0YzHhaoqEEGQDiSIU",
        authDomain: "sparta-10a22.firebaseapp.com",
        projectId: "sparta-10a22",
        storageBucket: "sparta-10a22.firebasestorage.app",
        messagingSenderId: "141923072753",
        appId: "1:141923072753:web:e82145d4c5de4e0d1ac750",
        measurementId: "G-YL2K2ST8Y6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    $('#guestbook').hide();

    $('#add_btn').on('click', function () {
        const $gb = $('#guestbook');
        const open = !$gb.is(':visible');

        if (open) {
            $gb.slideDown(180, () => $('#gb_comment').trigger('focus'));
            $(this).text('ë‹«ê¸°');
        } else {
            $gb.slideUp(180);
            $(this).text('ì‘ì„±í•˜ê¸°');
        }
    });


    //ë“±ë¡
    $("#save_btn").click(async function () {
        try {
            let comment = $('#gb_comment').val();
            let pwd = $('#gb_pwd').val();

            if (!comment && !pwd)
                return alert('ë‚´ìš©ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
            else if (!comment)
                return alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
            else if (!pwd)
                return alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');


            await addDoc(collection(db, "comments"), {
                comment: comment,
                //comment_id: comment_id_cnt,
                created_at: serverTimestamp(),
                pwd: pwd
            });
            alert('ì €ì¥ì™„ë£Œ!');
            window.location.reload();
        } catch (e) {
            console.error("Error adding document: ", e);
        }
    });

    async function load_comments() {
        const q = query(collection(db, "comments"), orderBy("created_at", "desc"));
        const querySnapshot = await getDocs(q);

        $("#comment_list").empty();

        querySnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const id = docSnap.id;
            const comment = data.comment ?? "(ë‚´ìš© ì—†ìŒ)";

            const temp_html = `
      <div class="comment_item" data-id="${id}">
        <p style="margin-bottom:6px;">${comment}</p>
        <div style="margin-top:8px;">
          <button class="edit-btn">ìˆ˜ì •</button>
          <button class="delete-btn">ì‚­ì œ</button>
        </div>
        <hr/>
      </div>
    `;
            $("#comment_list").append(temp_html);
        });
    }


    load_comments();

    // ì‚­ì œ
    $(document).on('click', '.delete-btn', async function () {
        const $item = $(this).closest('.comment_item');
        const id = $item.data('id');

        const input_pwd = prompt('ì‚­ì œ ë¹„ë°€ë²ˆí˜¸(4ìë¦¬)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        if (input_pwd == null || input_pwd === '') return;

        const snap = await getDoc(doc(db, "comments", id));
        if (!snap.exists()) return alert('ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

        const saved_pwd = snap.data().pwd;
        if (saved_pwd !== input_pwd) return alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');

        await deleteDoc(doc(db, "comments", id));
        alert('ì‚­ì œ ì™„ë£Œ');
        load_comments();
    });

    // ìˆ˜ì •
    $(document).on('click', '.edit-btn', async function () {
        const $item = $(this).closest('.comment_item');
        const id = $item.data('id');

        const input_pwd = prompt('ìˆ˜ì • ë¹„ë°€ë²ˆí˜¸(4ìë¦¬)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        if (input_pwd == null || input_pwd === '') return;

        const snap = await getDoc(doc(db, "comments", id));
        if (!snap.exists()) return alert('ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

        const data = snap.data();
        if (data.pwd !== input_pwd) return alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');

        const new_comment = prompt('ìƒˆë¡œìš´ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:', data.comment ?? '');
        if (new_comment == null) return;

        await updateDoc(doc(db, "comments", id), { comment: new_comment });
        alert('ìˆ˜ì • ì™„ë£Œ');
        load_comments();
    });





</script>
<html>